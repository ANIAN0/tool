# 第3期需求讨论记录

## 讨论一：需求方向确认

**日期**：2026-02-23

**讨论内容**：
用户提出第3期两个需求方向：
1. 登录功能：用户名密码登录，未登录不可使用chat页面，API统一鉴权
2. Agent记忆功能：参考ai-sdk记忆文档

**AI SDK记忆方案分析**：

| 方案 | 工作量 | 灵活性 | Provider锁定 |
|------|--------|--------|--------------|
| Provider-Defined Tools | 低 | 中 | 有 |
| Memory Providers | 低 | 低 | 依赖外部服务 |
| Custom Tool | 高 | 高 | 无 |

---

## 讨论二：登录功能细节

**日期**：2026-02-23

**确认事项**：
1. **用户注册**：需要注册页面，使用用户名+密码+邀请码，邀请码在环境变量配置
2. **会话管理**：选择JWT方案（7天有效期+自动刷新）
3. **鉴权范围**：参考Supabase匿名用户逻辑
   - 初始生成userId标记为匿名用户
   - 注册时保留userId，变为认证用户
   - 公开页面/Agent无需登录，私有页面/Agent需要登录
4. **技术选型**：轻量级自研认证系统（标准库不支持匿名升级场景）

**技术选型评估**：

| 方案 | 匹配度 | 原因 |
|------|--------|------|
| Supabase Auth | ⭐⭐ | 需要迁移或双数据库 |
| Auth.js | ⭐⭐ | 不支持匿名升级场景 |
| 自行开发 | ⭐⭐⭐⭐⭐ | 完全控制，无缝集成现有匿名ID方案 |

---

## 讨论三：记忆功能细节

**日期**：2026-02-23

**确认事项**：

### 1. 记忆类型
- **短期记忆**：已实现（每次调用LLM传入历史消息）
- **长期记忆**：需要实现（每个Agent独立）

### 2. 记忆粒度
- **用户级记忆**：需要（用户记忆不互相污染）
- **对话级记忆**：已实现（每次调用LLM传入历史消息）

### 3. 存储后端
- 使用Mem0云服务

### 4. 记忆操作
- 自动提取 + 手动管理结合
- 前期使用Mem0后台管理，后期按需自建

---

## 讨论四：三层记忆结构设计

**日期**：2026-02-23

**用户提出的三层记忆结构**：

```
┌─────────────────────────────────────────────────────────────┐
│                    用户全局记忆 (User Global)                 │
│  归属：仅属于特定用户                                          │
│  内容：用户通用画像、偏好设置、基础事实                          │
│  读取：所有被授权的Agent可读取                                  │
│  场景：用户告诉旅游Agent喜欢靠窗座位，订票Agent也能读取到         │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    Agent全局记忆 (Agent Global)               │
│  归属：属于特定Agent                                          │
│  内容：Agent的系统级知识库                                     │
│  读取：该Agent面向所有用户都可读取                              │
│  场景：法律顾问Agent积累的最新判例，对所有用户生效               │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    交互记忆 (Interaction)                     │
│  归属：特定的 {User_ID, Agent_ID} 组合                        │
│  内容：私有对话历史、共同完成的任务进度                          │
│  读取：严格隔离，只能在当前用户与当前Agent交互时激活              │
│  场景：用户和心理辅导Agent的对话，不被工作助理Agent读取           │
└─────────────────────────────────────────────────────────────┘
```

**Mem0实现方式**：

| 记忆层级 | user_id | metadata |
|----------|---------|----------|
| 用户全局记忆 | `user_xxx` | `{ type: "user_global" }` |
| Agent全局记忆 | `agent_development` | `{ type: "agent_global" }` |
| 交互记忆 | `user_xxx` | `{ agent_id: "development", type: "interaction" }` |

---

## 讨论五：最终确认

**日期**：2026-02-23

**确认事项**：

### 登录功能
- ✅ 轻量级自研JWT认证系统
- ✅ 匿名用户 → 注册 → 认证用户（保留userId）
- ✅ JWT + 7天有效期 + 自动刷新
- ✅ 公开/私有资源区分

### 记忆功能
- ✅ 仅开发Agent启用记忆
- ✅ 三层记忆结构
- ✅ Mem0云服务
- ✅ 自动注入 + 手动管理
- ✅ 不依赖登录（匿名用户也可有记忆）
- ✅ Agent全局记忆：Agent在与用户交互过程中自动积累

**功能点总数**：20个
- 登录功能：14个功能点
- 记忆功能：6个功能点

---

## 待办事项

1. 创建需求文档 ✅
2. 创建开发进展文档（开发阶段）
3. 开始功能点开发

---

## 讨论六：记忆管理Agent重构

**日期**：2026-02-23

**问题发现**：
1. 当前记忆提取使用简化版 `extractMemorySimple`，只匹配特定模式（`记住：...`、`我喜欢...`）
2. 简化版无法区分三层记忆，实际意义不大
3. 记忆提取逻辑与主聊天流程混杂，不够清晰

**重构方向**：
- 移除简化版记忆提取代码
- 创建独立的记忆管理 Agent
- 使用 workflows 实现固定流程
- 集成 Mem0 MCP Server

---

## 讨论七：记忆管理Agent架构设计

**日期**：2026-02-23

**架构设计**：

```
用户发送消息
    ↓
主聊天 Agent (streamText)
    ↓
并行触发（异步，不阻塞聊天）:
    - 记忆管理 Agent (workflow)
        1. 评估记忆价值
        2. 分类记忆类型
        3. 检索相关记忆
        4. 添加/更新/删除记忆
        ↓
    通过 Mem0 MCP Server 操作记忆
```

**技术选型**：

| 组件 | 技术 | 说明 |
|------|------|------|
| 模型 | Qwen/Qwen3-8B (SiliconFlow) | 小模型 + workflows 降低成本 |
| 工具 | Mem0 MCP Server | 官方 MCP，无需自己封装 |
| Agent 模式 | Workflow | 固定步骤流程 |
| 调用方式 | 异步非阻塞 | 不影响聊天响应速度 |

**Workflow 步骤设计**：

1. **步骤1：评估记忆价值**
   - 输入：用户消息、助手回复
   - 输出：`{ hasValue: boolean, score: number, reason: string }`

2. **步骤2：对记忆进行分类**
   - 输入：消息内容、用户ID、Agent ID
   - 输出：`{ type: 'user_global' | 'agent_global' | 'interaction' }`

3. **步骤3：检索相关记忆**
   - 输入：查询内容、记忆类型
   - 输出：相关记忆列表

4. **步骤4：决策并执行**
   - 输入：相关记忆、评估结果
   - 动作：add | update | delete | skip

**Mem0 MCP 工具**：

- `mem0_add` - 添加记忆
- `mem0_search` - 搜索记忆
- `mem0_get_all` - 获取所有记忆
- `mem0_update` - 更新记忆
- `mem0_delete` - 删除记忆

**实现文件结构**：

```
lib/agents/
  ├── memory-agent.ts          # 记忆管理 Agent 定义
  ├── memory-workflow.ts       # Workflow 步骤定义
lib/memory/
  ├── index.ts                  # 导出（清理简化版代码）
  ├── mem0-client.ts            # 保留（用于类型定义）
  ├── memory-service.ts         # 移除或保留作为备用
  ├── memory-extractor.ts       # 完全移除
  ├── prompt-builder.ts         # 保留（构建记忆提示词）
```

**最佳实践**：

1. ✅ 异步触发：使用 `void` 调用，不 await
2. ✅ 错误隔离：记忆失败不影响聊天，只记录日志
3. ✅ 成本控制：使用小模型 + workflows 固定提示词
4. ✅ 类型安全：使用 `Output.object` 结构化输出
5. ✅ 可观测性：添加详细日志

**实现优先级**：

1. ✅ 检查 Mem0 MCP Server 兼容性
2. ✅ 实现记忆管理 Agent（workflows）
3. ✅ 集成到 `/api/chat` 路由
4. ✅ 清理简化版代码
5. ✅ 测试验证

---

## 讨论八：代码审查与最佳实践修复

**日期**：2026-02-23

**背景**：
代码审查 Agent 对第3期代码进行了最佳实践检查，发现了一些需要修复的问题。

**检查结果汇总**：

| 类别 | 严重程度 | 问题数量 | 主要问题 |
|------|----------|----------|----------|
| Bundle 优化 | 🔴 严重 | 2 | Barrel imports, 动态 require |
| React 性能 | 🟡 中等 | 3 | useEffect 依赖, 缺少 cache(), localStorage 缓存 |
| AI SDK | 🟡 中等 | 2 | 手动 JSON 解析, 类型安全 |
| 整体评估 | 🟢 良好 | - | 核心功能实现正确，有优化空间 |

**修复内容**：

### 1. 严重问题修复

1. **Barrel File Imports** (`lib/db/index.ts`, `lib/auth/index.ts`)
   - 问题：使用 `export *` 导致每次导入都加载整个模块树
   - 解决：在 `next.config.ts` 中配置 `optimizePackageImports`

2. **动态 require 使用** (`lib/auth/middleware.ts:180`)
   - 问题：使用 `require` 同步加载模块
   - 解决：改为动态 `import()` 异步加载

### 2. 中等问题修复

3. **useEffect 依赖问题** (`components/auth/auth-guard.tsx:107`)
   - 问题：`onUnauthorized` 每次渲染都变化导致 useEffect 重复执行
   - 解决：使用 `useRef` 存储回调

4. **未使用 React.cache()** (`lib/db/users.ts`)
   - 问题：同一请求内多次调用相同数据库查询会重复执行
   - 解决：使用 `cache()` 包装 `getUserById` 和 `getUserByUsername`

5. **localStorage 直接读取** (`lib/hooks/use-auth.ts`)
   - 问题：每次调用都读取 localStorage
   - 解决：实现带版本控制的内存缓存机制

**修复文件列表**：
- `next.config.ts` - 添加 optimizePackageImports 配置
- `lib/auth/middleware.ts` - 修复 require 问题
- `components/auth/auth-guard.tsx` - 修复 useEffect 依赖
- `lib/db/users.ts` - 添加 React.cache()
- `lib/hooks/use-auth.ts` - 添加 localStorage 缓存

---

## 讨论九：记忆管理Agent集成

**日期**：2026-02-23

**已完成**：
在 `/api/chat` 路由中集成了记忆功能：

### 1. 记忆检索（Agent 调用前）
- 检查 Agent 配置中的 `enableMemory` 标志
- 调用 `retrieveMemories` 检索三层记忆
- 使用 `buildSystemPromptWithMemory` 将记忆注入系统提示词

### 2. 记忆提取（Agent 完成后异步）
- 使用 `void memoryWorkflow(...)` 异步触发
- 不阻塞聊天响应
- 错误隔离（记忆失败不影响聊天）

**修改文件**：
- `app/api/chat/route.ts` - 集成记忆检索和提取
- `lib/agents/index.ts` - 支持自定义系统提示词

---

## 待办事项

1. 创建需求文档 ✅
2. 创建开发进展文档（开发阶段）
3. 开始功能点开发
4. 实现记忆管理Agent重构 ✅
5. 代码审查最佳实践修复 ✅
6. 记忆管理Agent集成 ✅
