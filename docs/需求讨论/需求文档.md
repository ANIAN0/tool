# 第3期需求文档：登录功能 + Agent记忆功能

## 一、项目概述

### 1.1 目标
在第2期多Agent切换功能的基础上，实现两大核心功能：
1. **登录功能**：用户注册/登录系统，支持匿名用户升级，区分公开/私有资源
2. **Agent记忆功能**：为开发Agent添加三层记忆能力，实现跨对话知识持久化

### 1.2 核心决策

#### 登录功能决策

| 决策项 | 选择 |
|--------|------|
| 认证方案 | 轻量级自研JWT认证 |
| 注册方式 | 用户名 + 密码 + 邀请码（环境变量配置） |
| 会话管理 | JWT（7天有效期 + 自动刷新） |
| 匿名用户 | 保留现有匿名ID方案，注册时升级为认证用户 |
| 权限模型 | 公开页面/Agent无需登录，私有页面/Agent需要登录 |
| 数据存储 | 复用现有Turso数据库 |

#### 记忆功能决策

| 决策项 | 选择 |
|--------|------|
| 记忆服务 | Mem0云服务 |
| 启用范围 | 仅开发Agent |
| 记忆结构 | 三层：用户全局 / Agent全局 / 交互记忆 |
| 记忆操作 | 自动提取 + 手动管理（前期使用Mem0后台） |
| 登录依赖 | 不依赖登录（匿名用户也可有记忆） |

---

## 二、功能点拆分

---

## 模块一：登录功能

### 功能点1：用户表设计与迁移
**描述**：扩展现有数据库Schema，添加用户表和相关字段。

**涉及文件**：
- `lib/db/schema.ts`（修改）：添加users表定义
- `lib/db/index.ts`（修改）：导出新类型
- `scripts/migrate-users.ts`（新建）：用户表迁移脚本

**Schema设计**：
```sql
-- users表
CREATE TABLE users (
  id TEXT PRIMARY KEY,           -- 用户ID（匿名时生成，注册时保留）
  username TEXT UNIQUE,          -- 用户名（注册后设置）
  password_hash TEXT,            -- 密码哈希（注册后设置）
  is_anonymous INTEGER DEFAULT 1,-- 是否匿名用户（0:认证用户, 1:匿名用户）
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  updated_at TEXT DEFAULT CURRENT_TIMESTAMP
);

-- conversations表修改
ALTER TABLE conversations ADD COLUMN is_private INTEGER DEFAULT 0;
```

**验收标准**：
- users表创建成功
- conversations表添加is_private字段
- 迁移脚本可重复执行（幂等）

---

### 功能点2：用户数据访问层
**描述**：创建用户CRUD操作函数。

**涉及文件**：
- `lib/db/users.ts`（新建）：用户数据访问层

**功能要求**：
- `createAnonymousUser(id)`：创建匿名用户
- `getUserById(id)`：根据ID获取用户
- `getUserByUsername(username)`：根据用户名获取用户
- `upgradeToRegisteredUser(id, username, passwordHash)`：匿名用户升级
- `updateUserPassword(id, passwordHash)`：更新密码

**验收标准**：
- 所有函数类型正确
- 支持匿名用户和认证用户

---

### 功能点3：JWT认证工具
**描述**：创建JWT生成、验证、刷新工具函数。

**涉及文件**：
- `lib/auth/jwt.ts`（新建）：JWT工具函数
- `lib/auth/password.ts`（新建）：密码加密工具

**功能要求**：
- `generateAccessToken(userId)`：生成访问令牌（15分钟有效）
- `generateRefreshToken(userId)`：生成刷新令牌（7天有效）
- `verifyAccessToken(token)`：验证访问令牌
- `verifyRefreshToken(token)`：验证刷新令牌
- `hashPassword(password)`：密码加密（bcrypt）
- `verifyPassword(password, hash)`：密码验证

**验收标准**：
- JWT生成和验证正常
- 密码加密和验证正常
- 环境变量 `JWT_SECRET` 配置

---

### 功能点4：认证中间件
**描述**：创建认证中间件，用于API鉴权。

**涉及文件**：
- `lib/auth/middleware.ts`（新建）：认证中间件

**功能要求**：
- `withAuth(handler)`：包装API处理器，验证JWT
- `withOptionalAuth(handler)`：可选认证（支持匿名用户）
- `getOrCreateAnonymousUser(request)`：获取或创建匿名用户

**验收标准**：
- 中间件正确提取用户信息
- 支持认证和可选认证两种模式

---

### 功能点5：注册API
**描述**：创建用户注册API。

**涉及文件**：
- `app/api/auth/register/route.ts`（新建）：注册API

**功能要求**：
```typescript
POST /api/auth/register
Body: {
  username: string,    // 用户名
  password: string,    // 密码
  inviteCode: string,  // 邀请码
  anonymousId: string  // 当前匿名用户ID（用于升级）
}

Response: {
  success: boolean,
  user: { id, username },
  accessToken: string,
  refreshToken: string
}
```

**验收标准**：
- 邀请码验证正确
- 用户名唯一性检查
- 匿名用户升级成功
- 返回JWT令牌

---

### 功能点6：登录API
**描述**：创建用户登录API。

**涉及文件**：
- `app/api/auth/login/route.ts`（新建）：登录API

**功能要求**：
```typescript
POST /api/auth/login
Body: {
  username: string,
  password: string
}

Response: {
  success: boolean,
  user: { id, username },
  accessToken: string,
  refreshToken: string
}
```

**验收标准**：
- 用户名密码验证正确
- 返回JWT令牌

---

### 功能点7：刷新令牌API
**描述**：创建令牌刷新API。

**涉及文件**：
- `app/api/auth/refresh/route.ts`（新建）：刷新API

**功能要求**：
```typescript
POST /api/auth/refresh
Body: {
  refreshToken: string
}

Response: {
  success: boolean,
  accessToken: string,
  refreshToken: string
}
```

**验收标准**：
- 刷新令牌验证正确
- 返回新的访问令牌和刷新令牌

---

### 功能点8：获取当前用户API
**描述**：创建获取当前用户信息API。

**涉及文件**：
- `app/api/auth/me/route.ts`（新建）：获取用户API

**功能要求**：
```typescript
GET /api/auth/me
Headers: { Authorization: "Bearer {accessToken}" }

Response: {
  user: { id, username, isAnonymous }
}
```

**验收标准**：
- 返回当前用户信息
- 支持匿名用户

---

### 功能点9：注册页面
**描述**：创建用户注册页面。

**涉及文件**：
- `app/register/page.tsx`（新建）：注册页面
- `components/auth/register-form.tsx`（新建）：注册表单组件

**功能要求**：
- 用户名、密码、确认密码、邀请码输入
- 表单验证
- 调用注册API
- 注册成功后跳转到chat页面

**验收标准**：
- 表单验证正确
- 注册流程完整
- 错误提示友好

---

### 功能点10：登录页面
**描述**：创建用户登录页面。

**涉及文件**：
- `app/login/page.tsx`（新建）：登录页面
- `components/auth/login-form.tsx`（新建）：登录表单组件

**功能要求**：
- 用户名、密码输入
- 表单验证
- 调用登录API
- 登录成功后跳转到chat页面

**验收标准**：
- 表单验证正确
- 登录流程完整
- 错误提示友好

---

### 功能点11：认证状态管理
**描述**：创建前端认证状态管理Hook。

**涉及文件**：
- `lib/hooks/use-auth.ts`（新建）：认证Hook

**功能要求**：
- 管理登录状态
- 存储JWT令牌（localStorage + Cookie）
- 自动刷新令牌
- 登出功能

**验收标准**：
- 状态管理正确
- 令牌自动刷新
- 页面刷新后保持登录状态

---

### 功能点12：受保护路由
**描述**：实现受保护路由逻辑。

**涉及文件**：
- `app/chat/page.tsx`（修改）：添加权限检查
- `components/auth/auth-guard.tsx`（新建）：权限守卫组件

**功能要求**：
- 公开Agent：匿名用户可访问
- 私有Agent：需要登录
- 未登录访问私有资源时跳转登录页

**验收标准**：
- 权限检查正确
- 跳转逻辑正确

---

### 功能点13：导航栏认证状态
**描述**：在导航栏显示认证状态。

**涉及文件**：
- `components/layout/header.tsx`（修改）：添加用户状态显示

**功能要求**：
- 匿名用户：显示"登录"按钮
- 认证用户：显示用户名 + 下拉菜单（个人设置、登出）

**验收标准**：
- 状态显示正确
- 登出功能正常

---

### 功能点14：Agent配置扩展
**描述**：扩展Agent配置，添加公开/私有属性。

**涉及文件**：
- `lib/agents/config.ts`（修改）：添加isPrivate字段

**修改内容**：
```typescript
export interface AgentConfig {
  id: string;
  name: string;
  description: string;
  systemPrompt: string;
  tools?: Array<'bash' | 'tavily' | 'mcp'>;
  isPrivate?: boolean;  // 新增：是否需要登录
  enableMemory?: boolean;  // 新增：是否启用记忆
}

export const AGENTS: AgentConfig[] = [
  {
    id: 'production',
    name: '正式Agent',
    description: '正式环境使用的Agent',
    systemPrompt: '...',
    tools: ['bash'],
    isPrivate: false,  // 公开
    enableMemory: false,
  },
  {
    id: 'development',
    name: '开发Agent',
    description: '开发测试使用的Agent',
    systemPrompt: '...',
    tools: ['bash', 'tavily', 'mcp'],
    isPrivate: true,  // 私有，需要登录
    enableMemory: true,  // 启用记忆
  },
];
```

**验收标准**：
- 配置更新正确
- 类型检查通过

---

## 模块二：Agent记忆功能

### 功能点15：Mem0客户端配置
**描述**：创建Mem0客户端配置和工具函数。

**涉及文件**：
- `lib/memory/mem0-client.ts`（新建）：Mem0客户端配置

**功能要求**：
- 配置Mem0 API密钥
- 封装记忆操作函数
- 定义记忆层级类型

**验收标准**：
- Mem0客户端配置正确
- 环境变量 `MEM0_API_KEY` 配置

---

### 功能点16：三层记忆管理
**描述**：实现三层记忆的存取逻辑。

**涉及文件**：
- `lib/memory/memory-service.ts`（新建）：记忆服务

**功能要求**：

```typescript
// 记忆层级类型
type MemoryType = 'user_global' | 'agent_global' | 'interaction';

// 添加记忆
async function addMemory(params: {
  content: string;
  type: MemoryType;
  userId?: string;
  agentId?: string;
}): Promise<void>

// 检索记忆
async function retrieveMemories(params: {
  query: string;
  userId: string;
  agentId: string;
}): Promise<{
  userGlobal: string[];    // 用户全局记忆
  agentGlobal: string[];   // Agent全局记忆
  interaction: string[];   // 交互记忆
}>

// 删除记忆
async function deleteMemory(memoryId: string): Promise<void>

// 获取所有记忆（用于管理界面）
async function getAllMemories(params: {
  type: MemoryType;
  userId?: string;
  agentId?: string;
}): Promise<Memory[]>
```

**Mem0元数据设计**：
```typescript
// 用户全局记忆
{ user_id: userId, metadata: { type: 'user_global' } }

// Agent全局记忆
{ user_id: `agent_${agentId}`, metadata: { type: 'agent_global', agent_id: agentId } }

// 交互记忆
{ user_id: userId, metadata: { type: 'interaction', agent_id: agentId } }
```

**验收标准**：
- 三层记忆正确隔离
- 检索结果正确合并

---

### 功能点17：记忆注入到系统提示词
**描述**：在对话开始前检索记忆并注入系统提示词。

**涉及文件**：
- `lib/memory/prompt-builder.ts`（新建）：提示词构建器
- `app/api/chat/route.ts`（修改）：集成记忆检索

**功能要求**：
```typescript
// 构建带记忆的系统提示词
function buildSystemPromptWithMemory(params: {
  basePrompt: string;      // 基础系统提示词
  memories: {
    userGlobal: string[];
    agentGlobal: string[];
    interaction: string[];
  };
}): string

// 输出格式：
// [基础系统提示词]
// 
// ## 用户偏好
// - 用户喜欢靠窗座位
// - 用户偏好简洁的回答
// 
// ## 知识库
// - 最新法律判例：xxx
// 
// ## 之前的对话要点
// - 用户正在开发一个Next.js项目
// - 用户使用TypeScript
```

**验收标准**：
- 记忆正确注入
- 格式清晰易读

---

### 功能点18：记忆管理Agent（重构）
**描述**：创建独立的记忆管理Agent，使用workflows实现固定流程。

**涉及文件**：
- `lib/agents/memory-agent.ts`（新建）：记忆管理Agent定义
- `lib/agents/memory-workflow.ts`（新建）：Workflow步骤定义
- `app/api/chat/route.ts`（修改）：集成记忆管理Agent
- `lib/memory/memory-extractor.ts`（删除）：移除简化版代码

**功能要求**：

```typescript
// 记忆管理Agent配置
{
  model: Qwen/Qwen3-8B (SiliconFlow)
  tools: [Mem0 MCP Server tools]
  mode: workflow
}

// Workflow步骤
1. evaluateMemoryValue：评估记忆价值
   输入：{ userMessage, assistantMessage }
   输出：{ hasValue: boolean, score: number, reason: string }

2. classifyMemory：对记忆进行分类
   输入：{ message, userId, agentId }
   输出：{ type: 'user_global' | 'agent_global' | 'interaction' }

3. retrieveRelatedMemories：检索相关记忆
   输入：{ query, memoryType, userId, agentId }
   输出：{ memories: Memory[] }

4. decideAndExecute：决策并执行
   输入：{ memories, hasValue, content, type }
   输出：{ action: 'add' | 'update' | 'delete' | 'skip', memoryId?: string }
```

**调用方式**：

```typescript
// 在主聊天Agent的onFinish中异步触发记忆管理
void manageConversationMemory({
  userMessage,
  assistantMessage,
  userId,
  agentId,
});
```

**Mem0 MCP工具**：

- `mem0_add(message: string, userId: string, metadata?: object)`
- `mem0_search(query: string, userId: string, limit: number)`
- `mem0_get_all(userId: string)`
- `mem0_update(memoryId: string, text: string)`
- `mem0_delete(memoryId: string)`

**验收标准**：
- 记忆管理Agent独立运行
- 不阻塞主聊天流程
- 错误隔离（记忆失败不影响聊天）
- 正确区分三层记忆
- 使用结构化输出

---

### 功能点19：记忆管理Agent集成
**描述**：将记忆管理Agent集成到聊天API。

**涉及文件**：
- `app/api/chat/route.ts`（修改）：集成记忆管理Agent调用

**修改内容**：

```typescript
// 在主聊天Agent的onFinish中触发记忆管理
onFinish: async ({ text, finishReason, steps }) => {
  // ... 保存消息到数据库

  // 触发记忆管理（异步，不等待）
  if (agentConfig.enableMemory && isMemoryConfigured()) {
    try {
      const assistantText = steps.length > 0
        ? steps.map(s => s.text).filter(Boolean).join(" ")
        : text;

      // 异步调用记忆管理Agent，不等待完成
      void manageConversationMemory({
        userMessage: lastMessageText,
        assistantMessage: assistantText,
        userId,
        agentId: currentAgentId || DEFAULT_AGENT_ID,
      });
    } catch (memoryError) {
      // 记忆失败不影响聊天
      console.error("[Memory] 启动记忆管理失败:", memoryError);
    }
  }
}
```

**验收标准**：
- 记忆管理正确触发
- 不阻塞聊天响应
- 错误被正确捕获

---

### 功能点20：记忆API
**描述**：创建记忆管理API。

**涉及文件**：
- `app/api/memories/route.ts`（新建）：记忆列表API
- `app/api/memories/[id]/route.ts`（新建）：记忆详情/删除API

**功能要求**：
```typescript
// 获取记忆列表
GET /api/memories?type=user_global&agentId=development

// 删除记忆
DELETE /api/memories/[id]
```

**验收标准**：
-   API正确工作
-   权限验证正确

---

## 三、功能点总览

| 序号 | 功能点 | 模块 | 涉及文件数 | 状态 |
|------|--------|------|------------|------|
| 1 | 用户表设计与迁移 | 登录功能 | 3 | ✅ |
| 2 | 用户数据访问层 | 登录功能 | | ✅ |
| 3 | JWT认证工具 | 登录功能 | 2 | ✅ |
| 4 | 认证中间件 | 登录功能 | 1 | ✅ |
| 5 | 注册API | 登录功能 | 1 | ✅ |
| 6 | 登录API | 登录功能 | 1 | ✅ |
| 7 | 刷新令牌API | 登录功能 | 1 | ✅ |
| 8 | 获取当前用户API | 登录功能 | 1 | ✅ |
| 9 | 注册页面 | 登录功能 | 2 | ✅ |
| 10 | 登录页面 | 登录功能 | 2 | ✅ |
| 11 | 认证状态管理 | 登录功能 | 1 | ✅ |
| 12 | 受保护路由 | 登录功能 | 2 | ✅ |
| 13 | 导航栏认证状态 | | | ✅ |
| 14 | Agent配置扩展 | 登录功能 | 1 | ✅ |
| 15 | Mem0客户端配置 | 记忆功能 | 1 | ✅ |
| 16 | 三层记忆管理 | 记忆功能 | 1 | ✅ |
| 17 | 记忆注入到系统提示词 | 记忆功能 | 2 | ✅ |
| 18 | 记忆管理Agent（重构） | 记忆功能 | 3 | ⏳ |
| 19 | 记忆管理Agent集成 | 记忆功能 | 1 | ⏳ |
| 20 | 记忆API | 记忆功能 | 2 | ✅ |

**共计：20个功能点**

---

## 四、依赖关系

```
登录功能：
功能点1（Schema）→ 功能点2（数据访问层）→ 功能点3（JWT工具）→ 功能点4（中间件）
→ 功能点5-8（API）→ 功能点9-10（页面）→ 功能点11（状态管理）→ 功能点12-14（集成）

记忆功能：
功能点15（Mem0配置）→ 功能点16（记忆管理）→ 功能点17-18（注入和提取）
→ 功能点19（API）→ 功能点20（Agent集成）
```

---

## 五、环境变量配置

需要在 `.env` 中添加以下配置：

```env
# 登录功能
JWT_SECRET=your-jwt-secret-key
INVITE_CODE=your-invite-code

# 记忆功能
MEM0_API_KEY=your-mem0-api-key
```

---

## 六、注意事项

1. **安全性**：
   - 密码使用bcrypt加密
   - JWT使用强密钥
   - 邀请码不要硬编码

2. **兼容性**：
   - 保持现有匿名ID方案
   - 历史对话数据不丢失

3. **Mem0限制**：
   - 免费版有API调用限制
   - 需要监控使用量

4. **性能考虑**：
   - 记忆检索可能增加延迟
   - 考虑缓存策略

---

## 七、参考资源

- [Mem0 Documentation](https://docs.mem0.ai)
- [Mem0 MCP Server](https://docs.mem0.ai/platform/mem0-mcp)
- [Vercel AI SDK Workflows](https://ai-sdk.dev/docs/agents/workflows)
- [Vercel AI SDK OpenAI Compatible Providers](https://ai-sdk.dev/providers/openai-compatible-providers)
- [Vercel AI SDK Memory](https://ai-sdk.dev/docs/core-concepts/memory)
- [JWT.io](https://jwt.io)
- [bcrypt Documentation](https://github.com/kelektiv/node.bcrypt.js)
