# 第1期需求文档：多轮对话Agent

## 一、项目概述

### 1.1 目标
搭建一个支持多轮对话的Agent，具备对话页面、新建对话、历史对话管理、继续对话等核心功能。

### 1.2 技术栈
- 前端框架：Next.js 16.1.6
- AI SDK：ai (v6.0.94)
- UI组件：AI Elements + shadcn/ui
- AI服务：OpenRouter（支持模型切换）
- 数据存储：Turso Cloud
- 渲染：Markdown + 代码高亮（Streamdown）
- 开发工具：@ai-sdk/devtools

### 1.3 核心决策
| 决策项 | 选择 |
|--------|------|
| AI服务商 | OpenRouter（支持模型切换） |
| 数据存储 | Turso Cloud |
| 用户识别 | 匿名ID方案 |
| 用户认证 | 不需要 |
| 页面布局 | 左侧历史列表 + 右侧对话区 |
| 对话管理 | 支持删除、重命名 |
| 消息渲染 | Markdown + 代码高亮（使用AI Elements） |
| 流式输出 | 支持（使用 `toUIMessageStreamResponse`） |

### 1.4 AI Elements组件复用
本项目充分利用AI Elements提供的复合组件，避免重复造轮子：

| 功能 | AI Elements组件 | 说明 |
|------|-----------------|------|
| 输入区 | `PromptInput` 系列 | 支持附件、快捷键、loading状态 |
| 附件管理 | `Attachments` 系列 | 支持grid/inline/list三种布局变体 |
| 消息显示 | `Message` + `MessageResponse` | 支持Markdown、代码高亮、数学公式 |
| 对话容器 | `Conversation` 系列 | 自动滚动、空状态、导出功能 |
| 模型选择 | `ModelSelector` 系列 | 支持搜索、供应商logo分组 |

---

## 二、功能点拆分

### 模块一：基础设施

#### 功能点1：Turso数据库配置与连接
**描述**：配置Turso客户端连接，提供数据库操作的基础能力。

**涉及文件**：
- `lib/db.ts`（新建）：Turso客户端配置

**验收标准**：
- 成功连接Turso数据库
- 导出可复用的数据库客户端

---

#### 功能点2：匿名ID生成与存储
**描述**：首次访问时生成匿名用户ID，存储到localStorage，用于区分不同用户的数据。

**涉及文件**：
- `lib/anon-id.ts`（新建）：匿名ID生成与获取逻辑

**验收标准**：
- 首次访问生成唯一ID并存储到localStorage
- 后续访问能正确获取已有ID
- 提供getAnonId()方法供其他模块调用

---

#### 功能点3：AI SDK DevTools集成
**描述**：集成AI SDK开发工具，便于调试LLM请求、响应及工具调用过程。

**涉及文件**：
- `lib/ai.ts`（新建）：AI SDK配置与DevTools初始化

**功能要求**：
- 安装 `@ai-sdk/devtools`
- 配置DevTools中间件
- 仅在开发环境启用

**验收标准**：
- 开发环境下DevTools正常工作
- 可查看LLM请求/响应详情

---

### 模块二：数据存储

#### 功能点4：数据库Schema初始化
**描述**：定义conversations和messages表结构，提供数据库初始化能力。

**涉及文件**：
- `lib/db/schema.ts`（新建）：表结构定义
- `lib/db/index.ts`（新建）：统一导出

**表结构设计**：
```sql
-- conversations表
CREATE TABLE conversations (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL,
  title TEXT,
  model TEXT,
  created_at INTEGER,
  updated_at INTEGER
);

-- messages表
CREATE TABLE messages (
  id TEXT PRIMARY KEY,
  conversation_id TEXT NOT NULL,
  role TEXT NOT NULL, -- 'user' | 'assistant'
  content TEXT NOT NULL,
  created_at INTEGER,
  FOREIGN KEY (conversation_id) REFERENCES conversations(id)
);
```

**验收标准**：
- Schema定义完整
- 提供数据库初始化脚本

---

#### 功能点5：对话数据访问层
**描述**：封装对话的CRUD操作，供API层调用。

**涉及文件**：
- `lib/db/conversations.ts`（新建）：对话数据访问方法

**方法清单**：
- `createConversation(userId, title, model)` - 创建对话
- `getConversations(userId)` - 获取用户对话列表
- `getConversation(id)` - 获取单个对话
- `updateConversation(id, data)` - 更新对话（重命名）
- `deleteConversation(id)` - 删除对话

**验收标准**：
- 所有方法可正常调用
- 返回正确的数据格式

---

#### 功能点6：消息数据访问层
**描述**：封装消息的CRUD操作，供API层调用。

**涉及文件**：
- `lib/db/messages.ts`（新建）：消息数据访问方法

**方法清单**：
- `createMessage(conversationId, role, content)` - 创建消息
- `getMessages(conversationId)` - 获取对话消息列表
- `deleteMessagesByConversation(conversationId)` - 删除对话下所有消息

**验收标准**：
- 所有方法可正常调用
- 返回正确的数据格式

---

### 模块三：API

#### 功能点7：OpenRouter聊天API
**描述**：处理聊天请求，调用OpenRouter API，使用 `toUIMessageStreamResponse` 返回流式响应。

**涉及文件**：
- `app/api/chat/route.ts`（新建）：POST处理，流式响应

**功能要求**：
- 接收消息内容和对话ID
- 支持模型选择参数
- 调用OpenRouter API
- 使用 `toUIMessageStreamResponse()` 返回流式响应
- 将消息存储到数据库

**请求/响应格式**：
```
POST /api/chat
Request: { messages: UIMessage[], conversationId: string, model: string }
Response: toUIMessageStreamResponse({ sendSources: true, sendReasoning: true })
```

**验收标准**：
- 成功调用OpenRouter API
- 流式返回AI回复（使用 `toUIMessageStreamResponse`）
- 消息正确存储到数据库

---

#### 功能点8：对话列表API
**描述**：获取当前用户的所有对话列表。

**涉及文件**：
- `app/api/conversations/route.ts`（新建）：GET处理

**请求/响应格式**：
```
GET /api/conversations
Request Header: X-User-Id
Response: { conversations: Conversation[] }
```

**验收标准**：
- 返回当前用户的所有对话
- 按更新时间倒序排列

---

#### 功能点9：单个对话详情API
**描述**：获取指定对话的完整消息列表。

**涉及文件**：
- `app/api/conversations/[id]/route.ts`（新建）：GET处理

**请求/响应格式**：
```
GET /api/conversations/:id
Request Header: X-User-Id
Response: { conversation: Conversation, messages: Message[] }
```

**验收标准**：
- 返回对话信息和消息列表
- 验证用户权限（只能访问自己的对话）

---

#### 功能点10：删除对话API
**描述**：删除指定对话及其所有消息。

**涉及文件**：
- `app/api/conversations/[id]/route.ts`（修改）：添加DELETE处理

**请求/响应格式**：
```
DELETE /api/conversations/:id
Request Header: X-User-Id
Response: { success: boolean }
```

**验收标准**：
- 删除对话及关联消息
- 验证用户权限

---

#### 功能点11：重命名对话API
**描述**：更新对话标题。

**涉及文件**：
- `app/api/conversations/[id]/route.ts`（修改）：添加PATCH处理

**请求/响应格式**：
```
PATCH /api/conversations/:id
Request Header: X-User-Id
Request Body: { title: string }
Response: { success: boolean }
```

**验收标准**：
- 更新对话标题
- 验证用户权限

---

### 模块四：前端组件

> **重要说明**：本模块充分利用AI Elements提供的复合组件，减少开发工作量。

#### 功能点12：对话页面布局
**描述**：创建左右分栏的对话页面基础布局。

**涉及文件**：
- `app/chat/page.tsx`（新建）：页面主体，包含对话状态管理
- `app/chat/layout.tsx`（新建）：布局容器

**布局结构**：
```
┌─────────────────────────────────────┐
│         Layout (flex h-screen)       │
├──────────────┬──────────────────────┤
│   Sidebar    │      Chat Area       │
│   (w-64)     │      (flex-1)        │
│              │                       │
│  对话列表    │   消息列表 + 输入区   │
└──────────────┴──────────────────────┘
```

**验收标准**：
- 左右分栏布局正确
- 响应式适配（移动端可考虑隐藏侧边栏）

---

#### 功能点13：左侧对话列表组件
**描述**：显示历史对话列表，支持新建对话按钮，使用AI Elements的复合组件模式。

**涉及文件**：
- `components/chat/sidebar.tsx`（新建）：对话列表容器

**功能要求**：
- 显示"新建对话"按钮
- 列表展示历史对话
- 点击对话项切换当前对话
- 使用shadcn/ui的Card、Button组件

**验收标准**：
- 正确渲染对话列表
- 新建按钮可点击

---

#### 功能点14：对话列表项组件
**描述**：单个对话项，显示标题、时间，支持删除和重命名操作。

**涉及文件**：
- `components/chat/sidebar-item.tsx`（新建）：单个对话项

**功能要求**：
- 显示对话标题和时间
- 悬停显示操作按钮（删除、重命名）
- 点击切换到该对话
- 使用shadcn/ui的DropdownMenu组件

**验收标准**：
- 正确显示对话信息
- 操作按钮正常工作

---

#### 功能点15：对话消息区域组件
**描述**：使用AI Elements的 `Conversation` 系列组件构建消息显示区域。

**涉及文件**：
- `components/chat/chat-area.tsx`（新建）：对话区域容器

**使用的AI Elements组件**：
- `Conversation` - 自动滚动容器
- `ConversationContent` - 消息内容区
- `ConversationEmptyState` - 空状态提示
- `ConversationScrollButton` - 滚动到底部按钮

**验收标准**：
- 消息列表正确渲染
- 新消息自动滚动到底部
- 空状态正确显示

---

#### 功能点16：单条消息组件
**描述**：直接在ChatArea组件中使用AI Elements的 `Message` 系列组件渲染单条消息，无需额外封装。

**涉及文件**：
- `components/chat/chat-area.tsx`（已存在）：消息渲染集成

**使用的AI Elements组件**：
- `Message` - 消息容器（区分user/assistant样式）
- `MessageContent` - 消息内容区
- `MessageResponse` - 流式响应渲染（支持Markdown、代码高亮、数学公式、Mermaid）

**设计说明**：
- 直接使用AI Elements组件是最佳实践，无需额外封装
- MessageResponse已内置：Markdown渲染、代码高亮、数学公式、Mermaid图表
- 流式消息和静态消息使用相同组件，简化代码

**验收标准**：
- 消息样式正确（用户/AI区分）
- Markdown正确渲染
- 代码高亮正常
- 流式消息正确显示

---

#### 功能点17：消息输入组件
**描述**：使用AI Elements的 `PromptInput` 和 `Attachments` 系列组件构建输入区，支持附件上传和预览。

**涉及文件**：
- `components/chat/prompt-section.tsx`（新建）：输入区

**使用的AI Elements组件**：
- `PromptInput` - 表单容器（支持文件拖拽）
- `PromptInputTextarea` - 文本输入
- `PromptInputSubmit` - 提交按钮（支持loading状态）
- `PromptInputTools` - 工具区
- `PromptInputActionMenu` - 操作菜单（附件上传入口）
- `PromptInputActionAddAttachments` - 附件上传触发器
- `Attachments` - 附件容器（`variant: "grid" | "inline" | "list"`）
- `Attachment` - 单个附件项
- `AttachmentPreview` - 附件预览（图片/视频/图标）
- `AttachmentInfo` - 文件名显示
- `AttachmentRemove` - 删除按钮

**功能要求**：
- 文本输入框
- 发送按钮（支持loading状态、停止生成）
- Enter发送，Shift+Enter换行
- 发送时禁用输入
- 附件上传（点击或拖拽）
- 附件预览显示在输入框头部（使用 `PromptInputHeader`）
- 支持删除已上传附件

**验收标准**：
- 输入功能正常
- 快捷键正常工作
- loading状态正确显示
- 附件上传和预览正常
- 附件删除功能正常

---

#### 功能点18：模型选择器组件
**描述**：使用AI Elements的 `ModelSelector` 系列组件构建模型选择器。

**涉及文件**：
- `components/chat/model-selector.tsx`（新建）：模型选择下拉

**使用的AI Elements组件**：
- `ModelSelector` - 对话框容器
- `ModelSelectorTrigger` - 触发按钮
- `ModelSelectorContent` - 内容区
- `ModelSelectorItem` - 选项
- `ModelSelectorLogo` - 供应商logo

**功能要求**：
- 下拉选择模型
- 显示当前选中模型
- 显示供应商logo
- 支持搜索

**验收标准**：
- 选择器正常工作
- 选中状态正确显示
- logo正确加载

---

### 模块五：页面集成

#### 功能点19：创建新对话功能
**描述**：点击新建按钮，清空当前对话状态，等待用户发送第一条消息时由chat API自动创建对话。

**涉及文件**：
- `app/chat/page.tsx`（修改）：新建对话状态管理

**设计方案**：
- **方案1（已废弃）**：点击新建按钮时立即调用API创建空对话
- **方案2（采用）**：点击新建按钮时仅清空状态，发送第一条消息时由chat API自动创建对话

**方案2优势**：
1. 避免创建空对话污染数据库
2. 用户可能点击新建后没发消息就离开
3. chat API已有自动创建对话逻辑（功能点7实现）

**功能要求**：
- 清空当前对话ID和消息列表
- 重置为新对话状态
- 发送第一条消息时自动创建对话（复用功能点7逻辑）

**验收标准**：
- 点击新建按钮后进入新对话状态
- 发送第一条消息后自动创建对话并更新列表

---

#### 功能点20：加载历史对话并继续对话
**描述**：从列表选择历史对话，加载消息并继续对话。

**涉及文件**：
- `app/chat/page.tsx`（修改）：加载对话逻辑
- `components/chat/chat-area.tsx`（修改）：显示加载状态

**功能要求**：
- 点击对话项加载历史消息
- 显示加载状态
- 加载完成后可继续对话

**验收标准**：
- 正确加载历史消息
- 可继续发送新消息

---

#### 功能点21：删除对话功能
**描述**：删除对话并更新列表。

**涉及文件**：
- `components/chat/sidebar-item.tsx`（修改）：触发删除
- `components/chat/sidebar.tsx`（修改）：更新列表

**功能要求**：
- 确认删除提示
- 调用删除API
- 更新对话列表
- 如果删除的是当前对话，切换到其他对话

**验收标准**：
- 删除成功
- 列表正确更新

---

#### 功能点22：重命名对话功能
**描述**：修改对话标题。

**涉及文件**：
- `components/chat/sidebar-item.tsx`（修改）：内联编辑

**功能要求**：
- 点击编辑进入编辑模式
- 输入新标题
- 保存或取消

**验收标准**：
- 编辑功能正常
- 标题正确更新

---

#### 功能点23：发送消息并流式接收回复
**描述**：发送消息，调用API，流式显示AI回复。

**涉及文件**：
- `app/chat/page.tsx`（修改）：消息发送状态管理
- `components/chat/prompt-section.tsx`（修改）：触发发送
- `components/chat/chat-area.tsx`（修改）：显示流式消息

**功能要求**：
- 发送用户消息
- 显示用户消息
- 流式显示AI回复
- 保存消息到数据库

**验收标准**：
- 消息发送成功
- AI回复流式显示
- 消息正确保存

---

## 三、功能点总览

| 序号 | 功能点 | 模块 | 涉及文件数 | AI Elements复用 |
|------|--------|------|------------|-----------------|
| 1 | Turso数据库配置与连接 | 基础设施 | 1 | - |
| 2 | 匿名ID生成与存储 | 基础设施 | 1 | - |
| 3 | AI SDK DevTools集成 | 基础设施 | 1 | - |
| 4 | 数据库Schema初始化 | 数据存储 | 2 | - |
| 5 | 对话数据访问层 | 数据存储 | 1 | - |
| 6 | 消息数据访问层 | 数据存储 | 1 | - |
| 7 | OpenRouter聊天API | API | 1 | - |
| 8 | 对话列表API | API | 1 | - |
| 9 | 单个对话详情API | API | 1 | - |
| 10 | 删除对话API | API | 1 | - |
| 11 | 重命名对话API | API | 1 | - |
| 12 | 对话页面布局 | 前端组件 | 2 | - |
| 13 | 左侧对话列表组件 | 前端组件 | 1 | - |
| 14 | 对话列表项组件 | 前端组件 | 1 | - |
| 15 | 对话消息区域组件 | 前端组件 | 1 | Conversation系列 |
| 16 | 单条消息组件 | 前端组件 | 0 | Message系列（集成在功能点15） |
| 17 | 消息输入组件 | 前端组件 | 1 | PromptInput系列 |
| 18 | 模型选择器组件 | 前端组件 | 1 | ModelSelector系列 |
| 19 | 创建新对话功能 | 页面集成 | 2 | - |
| 20 | 加载历史对话并继续对话 | 页面集成 | 2 | - |
| 21 | 删除对话功能 | 页面集成 | 2 | - |
| 22 | 重命名对话功能 | 页面集成 | 1 | - |
| 23 | 发送消息并流式接收回复 | 页面集成 | 3 | - |

**共计：23个功能点，每个功能点涉及文件数≤3**

---

## 四、依赖关系

```
模块一（基础设施）→ 模块二（数据存储）→ 模块三（API）→ 模块四（前端组件）→ 模块五（页面集成）
```

同一模块内功能点可并行开发，不同模块需按依赖顺序开发。

---

## 五、参考资源

- [AI Elements 官方文档](https://elements.ai-sdk.dev)
- [AI Elements Chatbot 示例](https://elements.ai-sdk.dev/examples/chatbot)
- [AI SDK 6 文档](https://sdk.vercel.ai/docs)
- [OpenRouter API 文档](https://openrouter.ai/docs)
- [Turso 文档](https://docs.turso.tech)
